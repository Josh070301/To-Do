<!-- Toast Notifications -->
<p-toast position="bottom-right"/>
<div class="app-background w-full px-4 py-6">

  <div class="flex flex-col sm:flex-row items-center gap-2 w-full">
    <div class="flex items-center gap-2 w-full">
      <p-iconField iconPosition="left" class="w-full sm:w-64">
        <p-inputIcon class="pi pi-search" />
        <input 
          type="text" 
          pInputText 
          placeholder="Search task title"
          [(ngModel)]="searchTitle"
          (input)="filterTodos()"
          class="w-full"
        />
      </p-iconField>
      <p-button 
          label="Clear Filter" 
          [raised]="true" 
          severity="secondary" 
          (click)="clearFilter()"
          class="w-full sm:w-auto no-wrap-label"
      />
      <button
        type="button"
        class="ml-0 sm:ml-2 text-white hover:text-gray-200 focus:outline-none transition-colors"
        (click)="openGuide([
          'The search box filters tasks by title.',
          'Use the checkboxes to mark tasks as completed or pending.',
          'Click the pencil icon to edit a task, and the trash icon to delete a task.',
          'The Add a Task button opens a form to create a new task.'
        ])"
        pTooltip="Show Guide"
        tooltipPosition="bottom"
        aria-label="Show Guide"
      >
        <i class="pi pi-info-circle mr-2 mt-2" style="font-size: 1.5rem; color: white;"></i>
      </button>
    </div>

    <div
      class="bg-white text-gray-700 rounded-md shadow px-4 py-2 font-semibold flex items-center justify-center w-full sm:w-auto border border-gray-200"
    >
      <span class="mr-2">
        @if (getHour(currentDateAndTime) < 12) {
          <i class="pi pi-sun text-yellow-400" style="font-size: 1.25rem"></i>
        } @else if (getHour(currentDateAndTime) < 18) {
          <i class="pi pi-sun text-yellow-600" style="font-size: 1.25rem"></i>
        } @else {
          <i class="pi pi-moon text-blue-600" style="font-size: 1.25rem"></i>
        }
      </span>
      {{ currentDateAndTime }}
    </div>

    <button
      class="bg-gray-600 text-white py-2 px-4 rounded-md flex items-center gap-2 font-bold hover:bg-black focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors w-full sm:w-auto"
      (click)="openAddTaskDialog()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
      </svg>
      Add
    </button>
  </div>
  
  <br/>
  <div>
    <!--headers uses Dingbats UTF-8 -->
    <p-panel [header]="'My Tasks (' + totalTasksCount + ')'" [toggleable]="false" class="my-task-panel">
      <p-panel [header]="'Pending &#10025; (' + pendingTasksCount + ')' " [toggleable]="true" class="pending-panel">
        <p-table 
          [value]="todosPending" 
          dataKey="id" 
          [tableStyle]="{'min-width': '50rem'}" 
          [paginator]="true" 
          [rows]="5" 
          [rowsPerPageOptions]="[5, 10, 20]"
          >
          <ng-template #header>
              <tr>
                  <th>Controls</th>
                  <th pSortableColumn="title">
                    <div class="flex items-center gap-1">
                      Title
                      <p-sortIcon field="title"></p-sortIcon>
                    </div>
                  </th>
                  <th pSortableColumn="description">
                    <div class="flex items-center gap-1">
                      Description
                      <p-sortIcon field="description"></p-sortIcon>
                    </div>
                  </th>
                  <th pSortableColumn="date_deadline">
                    <div class="flex items-center gap-1">
                      Deadline
                      <p-sortIcon field="date_deadline"></p-sortIcon>
                    </div>
                  </th>
                  <th>
                    <div class="flex items-center gap-1">
                      Status
                    </div>
                  </th>
                  <th pSortableColumn="date_created">
                    <div class="flex items-center gap-1">
                      Created Date
                      <p-sortIcon field="date_created"></p-sortIcon>
                    </div>
                  </th>
              </tr>
          </ng-template>
          <ng-template #body let-todo>
            @if (!todo.completed) {
              <tr>
                <td>
                  <div class="flex flex-row items-center gap-2 flex-nowrap">
                    <p-checkbox 
                      [ngModel]="todo.completed"
                      [binary]="todo.completed" 
                      pTooltip="Mark as Completed"
                      tooltipPosition="bottom"
                      (onChange)="toggleTodo({id: todo.id})">
                    </p-checkbox>
                    <button
                      type="button"
                      class="text-blue-600 hover:text-blue-800 focus:outline-none"
                      pTooltip="Edit Task"
                      tooltipPosition="bottom"
                      (click)="openUpdateTaskDialog(todo)"
                      aria-label="Edit Task"
                    >
                      <i class="pi pi-pencil" style="font-size: 1rem"></i>
                    </button>
                    <button
                      type="button"
                      class="text-red-600 hover:text-red-800 focus:outline-none"
                      pTooltip="Delete Task"
                      tooltipPosition="bottom"
                      (click)="openConfirmDeletionDialog(todo.id)"
                      aria-label="Delete Task"
                    >
                      <i class="pi pi-trash" style="font-size: 1rem"></i>
                    </button>
                  </div>
                </td>
                <td class="whitespace-normal break-words max-w-xs">
                  {{todo.title}}
                </td>
                <td class="whitespace-normal break-words max-w-xs">
                  {{todo.description}}
                </td>
                <td
                  [class]="isPastDeadline(todo.date_deadline) ? 'text-red-600 font-bold' : ''"
                >
                  {{todo.date_deadline ? service.formatDate(todo.date_deadline) : 'None'}}
                </td>
                <td>{{todo.completed ? 'Completed' : 'Pending'}}</td>
                <td>{{service.formatDate(todo.date_created)}}</td>
              </tr>
            }
          </ng-template>
          <ng-template #emptymessage>
            <tr>
              <td colspan="5" class="text-center text-gray-500 py-4">
                No pending tasks found.
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-panel>
      
      <br/>
      <p-panel [header]="'Completed &#10003; (' + completedTasksCount + ')' " [toggleable]="true" class="completed-panel">
        <p-table 
          [value]="todosCompleted" 
          dataKey="id" 
          [tableStyle]="{'min-width': '50rem'}"
          [paginator]="true" 
          [rows]="5" 
          [rowsPerPageOptions]="[5, 10, 20]">
          <ng-template #header>
              <tr>
                  <th>Controls</th> 
                  <th pSortableColumn="title">
                    <div class="flex items-center gap-1">
                      Title
                      <p-sortIcon field="title"></p-sortIcon>
                    </div>
                  </th>
                  <th pSortableColumn="description">
                    <div class="flex items-center gap-1">
                      Description
                      <p-sortIcon field="description"></p-sortIcon>
                    </div>
                  </th>
                  <th pSortableColumn="date_deadline">
                    <div class="flex items-center gap-1">
                      Deadline
                      <p-sortIcon field="date_deadline"></p-sortIcon>
                    </div>
                  </th>
                  <th>
                    <div class="flex items-center gap-1">
                      Status
                    </div>
                  </th>
                  <th pSortableColumn="date_created">
                    <div class="flex items-center gap-1">
                      Created Date
                      <p-sortIcon field="date_created"></p-sortIcon>
                    </div>
                  </th>
              </tr>
          </ng-template>
          <ng-template #body let-todo>
            @if (todo.completed) {
              <tr class="bg-lime-200">
                <td>
                  <div class="flex flex-row items-center gap-2 flex-nowrap">
                    <p-checkbox 
                      [ngModel]="todo.completed"
                      [binary]="todo.completed" 
                      pTooltip="Change To Pending"
                      tooltipPosition="bottom"
                      (onChange)="toggleTodo({id: todo.id})">
                    </p-checkbox>
                    <button
                      type="button"
                      class="text-blue-600 hover:text-blue-800 focus:outline-none"
                      pTooltip="Edit Task"
                      tooltipPosition="bottom"
                      (click)="openUpdateTaskDialog(todo)"
                      aria-label="Edit Task"
                    >
                      <i class="pi pi-pencil" style="font-size: 1rem"></i>
                    </button>
                    <button
                      type="button"
                      class="text-red-600 hover:text-red-800 focus:outline-none"
                      pTooltip="Delete Task"
                      tooltipPosition="bottom"
                      (click)="openConfirmDeletionDialog(todo.id)"
                      aria-label="Delete Task"
                    >
                      <i class="pi pi-trash" style="font-size: 1rem"></i>
                    </button>
                  </div>
                </td>
                <td class="whitespace-normal break-words max-w-xs">
                  {{todo.title}}
                </td>
                <td class="whitespace-normal break-words max-w-xs">
                  {{todo.description}}
                </td>
                <td
                  [class]="isPastDeadline(todo.date_deadline) ? 'text-red-600 font-bold' : ''"
                >
                  {{todo.date_deadline ? service.formatDate(todo.date_deadline) : 'None'}}
                </td>
                <td>{{todo.completed ? 'Completed' : 'Pending'}}</td>
                <td>{{service.formatDate(todo.date_created)}}</td>
              </tr>
            }
          </ng-template>
          <ng-template #emptymessage>
            <tr>
              <td colspan="5" class="text-center text-gray-500 py-4">
                No completed tasks found.
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-panel>
    </p-panel>
  </div>

  <div class="card flex justify-center mt-4">
    <div class="flex flex-col items-center">
      <app-pie-chart
        [chartLabels]="['Completed', 'Pending']"
        [chartColors]="['#7589c9', '#66b672']"
        [chartHoverColors]="['#5a6ea6', '#4e995a']"
        [chartData]="[todosPending.length, todosCompleted.length]"
      />
    </div>
  </div>

</div>

<!-- Tailwind Modal - Add Task -->
@if (addTaskDialog()) {
  <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50" (click)="closeAddTaskDialog()">
    <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="flex items-start justify-between p-4 border-b rounded-t">
        <h3 class="text-xl font-semibold text-gray-900">Add Task</h3>
        <button 
          type="button" 
          class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" 
          (click)="closeAddTaskDialog()">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <!-- Body -->
      <div class="p-6">
        <app-add-task 
          (addTask)="handleAddTask($event)"
          (cancel)="closeAddTaskDialog()">
        </app-add-task>
      </div>
    </div>
  </div>
}

@if (updateTaskDialog()) {
  <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50" (click)="closeUpdateTaskDialog()">
    <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4" (click)="$event.stopPropagation()">
      <div class="flex items-start justify-between p-4 border-b rounded-t">
        <h3 class="text-xl font-semibold text-gray-900">Update Task</h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" (click)="closeUpdateTaskDialog()">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
      </div>
      <div class="p-6">
        <app-update-task
          [id]="todoToUpdate?.id ?? ''"
          [title]="todoToUpdate?.title ?? ''"
          [description]="todoToUpdate?.description ?? ''"
          [date_deadline]="todoToUpdate?.date_deadline ?? undefined"
          (updateTask)="handleUpdateTask($event)"
          (cancel)="closeUpdateTaskDialog()"
        ></app-update-task>
      </div>
    </div>
  </div>
}

<!-- Tailwind Modal - Delete Confirmation -->
@if (confirmDeletionDialog()) {
  <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50" (click)="closeConfirmDeletionDialog()">
    <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="flex items-start justify-between p-4 border-b rounded-t">
        <h3 class="text-xl font-semibold text-gray-900">Confirm Deletion</h3>
        <button 
          type="button" 
          class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" 
          (click)="closeConfirmDeletionDialog()">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <!-- Body -->
      <div class="p-6">
        <app-delete-task
          (confirm)="handleConfirmDeletion()"
          (cancel)="closeConfirmDeletionDialog()">
        </app-delete-task>
      </div>
    </div>
  </div>
}

@if (guideDialog()) {
  <app-guide [items]="guideItems" (close)="closeGuide()"></app-guide>
}